# RDS MySQL实例间的双向同步

数据传输服务DTS（Data Transmission Service）支持两个MySQL数据库之间的双向数据实时同步，适用于异地多活（单元化）、数据异地容灾等多种应用场景。本文以RDS MySQL实例为例，介绍双向数据同步的配置步骤。

## 前提条件

数据同步的源和目标RDS MySQL实例已存在，如不存在请[创建RDS实例](https://www.alibabacloud.com/help/zh/doc-detail/26117.htm)。

## 注意事项

DTS在执行全量数据初始化时将占用源库和目标库一定的读写资源，可能会导致数据库的负载上升，在数据库性能较差、规格较低或业务量较大的情况下（例如源库有大量慢SQL、存在无主键表或目标库存在死锁等），可能会加重数据库压力，甚至导致数据库服务不可用。因此您需要在执行数据同步前评估源库和目标库的性能，同时建议您在业务低峰期执行数据同步（例如源库和目标库的CPU负载在30%以下）。

## 支持的同步架构

目前DTS仅支持两个MySQL数据库之间的双向同步，暂不支持多个MySQL数据库之间的双向同步。

![双向数据同步架构](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1320649951/p41047.png)

## 支持的数据源

MySQL间的双向数据同步支持以下数据源，本文以RDS MySQL实例为数据源介绍配置流程，其他数据源的配置流程与该案例类似。

|同步源数据库|同步目的数据库|
|:-----|:------|
|-   RDS MySQL实例
-   ECS上的自建数据库
-   通过专线、VPN网关或智能网关接入的自建数据库
-   通过数据库网关接入的自建数据库
-   通过云企业网CEN接入的自建数据库

|-   RDS MySQL实例
-   ECS上的自建数据库
-   通过专线、VPN网关或智能网关接入的自建数据库
-   通过数据库网关接入的自建数据库
-   通过云企业网CEN接入的自建数据库 |

## 支持同步的SQL操作

|操作类型|SQL操作语句|
|----|-------|
|DML|INSERT、UPDATE、DELETE、REPLACE|
|DDL|-   ALTER TABLE、ALTER VIEW
-   CREATE FUNCTION、CREATE INDEX、CREATE PROCEDURE、CREATE TABLE、CREATE VIEW
-   DROP INDEX、DROP TABLE
-   RENAME TABLE
-   TRUNCATE TABLE |

## 支持的冲突检测

为保障同步数据的一致性，您需要确保同一个主键、业务主键或唯一键的记录只在双向同步的一个节点进行更新。如果同时更新则会按照您在数据同步作业中配置的冲突修复策略进行响应。

DTS通过冲突检测和修复最大程度地维护双向同步实例的稳定性。目前DTS支持进行检测的冲突类型包括：

-   INSERT导致的唯一性冲突

    同步INSERT语句时违背了唯一性约束，例如双向同步的两个节点同时或者在极为接近的时间INSERT某个主键值相同的记录，那么同步到对端时，会因为已经存在相同主键值的记录，导致Insert同步失败。

-   UPDATE更新的记录不完全匹配
    -   UPDATE要更新的记录在同步目标实例中不存在时，DTS会自动转化为INSERT，此时可能会出现唯一键的唯一性冲突。
    -   UPDATE要更新的记录出现主键或唯一键冲突。
-   DELETE对应的记录不存在

    DELETE要删除的记录在同步的目标实例中不存在。出现这种冲突时，不论配置何种冲突修复策略，DTS都会自动忽略DELETE操作。


**说明：**

-   由于数据同步两端的系统时间可能存在差异、同步存在延时等多种因素，DTS无法完全保证冲突检测机制能够完全防止数据的冲突。在使用双向同步时，您需要在业务层面配合进行相应的改造，保证同一个主键、业务主键或唯一键的记录只在双向同步的某个节点进行更新。
-   对于上述数据同步的冲突，DTS提供了修复策略，您可以在配置双向同步时选择。

## 功能限制

-   如果同步对象为单个或多个表（非整库），那么在数据同步时，请勿对源库的同步对象使用gh-ost或pt-online-schema-change等类似工具执行在线DDL变更，否则会导致同步失败。

    **说明：** 为避免同步失败，数据同步期间您可以使用数据管理DMS（Data Management Service）来执行在线DDL变更，详情请参见[不锁表结构变更](https://www.alibabacloud.com/help/zh/doc-detail/98373.htm)。

-   不兼容触发器

    同步对象为整个库且这个库中包含了会更新同步表内容的触发器，那么可能导致同步数据不一致。例如数据库中存在了两个表A和B。表A上有一个触发器，触发器内容为在INSERT一条数据到表A之后，在表B中插入一条数据。这种情况在同步过程中，如果源实例表A上进行了INSERT操作，则会导致表B在源实例跟目标实例数据不一致。

    此类情况须要将目标实例中的对应触发器删除掉，表B的数据由源实例同步过去，详情请参见[源库存在触发器时如何配置同步作业](/intl.zh-CN/最佳实践/源库存在触发器时如何配置同步作业.md)。

-   RENAME TABLE限制

    RENAME TABLE操作可能导致同步数据不一致。例如同步对象只包含某个表，如果同步过程中源实例对该表执行了重命名操作，那么该表的数据将不会同步到目标库。为避免该问题，您可以在数据同步配置时将该表所属的整个数据库作为同步对象。

-   DDL语法同步方向限制

    为保障双向同步链路的稳定性，对于同一张表的DDL更新只能在其中一个同步方向进行同步。即一旦某个同步方向配置了DDL同步，则在反方向上不支持DDL同步，只进行DML同步。


## 操作步骤

1.  购买双向数据同步实例，详情请参见[购买数据同步作业]()。

    **说明：** 购买时，源实例和目标实例均选择为**MySQL**，并选择同步拓扑为**双向同步**。

2.  登录[数据传输控制台](https://dts-intl.console.aliyun.com/)。
3.  在左侧导航栏，单击**数据同步**。
4.  在同步作业列表页面顶部，选择同步的目标实例所属地域。

    ![选择地域](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7349459951/p50604.png)

5.  定位至已购买的数据同步实例，单击该实例下第一个同步作业的**配置同步链路**。

    **说明：** 一个双向数据同步实例会包含两个同步作业，需要分别进行配置。

    ![双向同步任务](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1249459951/p41151.png)

6.  配置同步通道的源实例及目标实例信息。

    ![RDS双向同步源目实例配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1320649951/p41052.png)

    |类别|配置|说明|
    |:-|:-|:-|
    |无|同步作业名称|DTS会自动生成一个同步作业名称，建议配置具有业务意义的名称（无唯一性要求），便于后续识别。|
    |源实例信息|实例类型|选择**RDS实例**。|
    |实例地区|购买数据同步实例时选择的源实例地域信息，不可变更。|
    |实例ID|选择作为数据同步源的RDS实例ID。|
    |数据库账号|填入源RDS的数据库账号。 **说明：** 当源RDS实例的数据库类型为**MySQL 5.5**或**MySQL 5.6**时，没有**数据库账号**和**数据库密码**配置选项。 |
    |数据库密码|填入数据库账号对应的密码。|
    |连接方式|根据需求选择**非加密连接**或**SSL安全连接**。如果设置为**SSL安全连接**，您需要提前开启RDS实例的SSL加密功能，详情请参见[设置SSL加密](https://www.alibabacloud.com/help/zh/doc-detail/96120.htm)。 **说明：** 目前仅中国内地及中国香港地域支持设置**连接方式**。 |
    |目标实例信息|实例类型|选择**RDS实例**。|
    |实例地区|购买数据同步实例时选择的目标实例地域信息，不可变更。|
    |实例ID|选择作为数据同步目标的RDS实例ID。|
    |数据库账号|填入目标RDS的数据库账号。 **说明：** 当目标RDS实例的数据库类型为**MySQL 5.5**或**MySQL 5.6**时，没有**数据库账号**和**数据库密码**配置选项。 |
    |数据库密码|填入数据库账号对应的密码。|
    |连接方式|根据需求选择**非加密连接**或**SSL安全连接**。如果设置为**SSL安全连接**，您需要提前开启RDS实例的SSL加密功能，详情请参见[设置SSL加密](https://www.alibabacloud.com/help/zh/doc-detail/96120.htm)。 **说明：** 目前仅中国内地及中国香港地域支持设置**连接方式**。 |

7.  单击页面右下角的**授权白名单并进入下一步**。
8.  配置同步策略及对象信息。

    ![RDS双向同步对象及策略配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1320649951/p41053.png)

    |类别|配置|说明|
    |:-|:-|:-|
    |同步策略配置|是否过滤DDL|    -   选择为**是**：不同步DDL操作。
    -   选择为**否**：同步DDL操作。

**说明：** 一旦该同步方向选择同步DDL操作，那么同一张表在另一个同步方向则不支持同步DDL操作。 |
    |DML同步类型|选择需要同步的DML类型，默认为**Insert**、**Update**、**Delete**，您可以根据业务需求调整。|
    |冲突修复策略|选择同步冲突的修复策略，默认为**TaskFailed**，您可以根据业务情况选择合适的冲突修复策略。     -   **TaskFailed**（遇到冲突，任务报错退出）

默认的冲突修复策略。当数据同步遇到上述冲突类型时，同步任务直接报错并退出，同步任务进入失败状态，需要用户介入修复任务。

    -   **Ignore**（遇到冲突，直接使用目标实例中的冲突记录）

当数据同步遇到上述的冲突类型时，直接跳过当前同步语句，继续往下执行，选择使用目标库中的冲突记录。

    -   **Overwrite**（遇到冲突，直接覆盖目标实例中的冲突记录）

当数据同步遇到上述的冲突类型时，直接覆盖目标库中的冲突记录。 |
    |目标已存在表的处理模式|    -   **预检查并报错拦截**：检查目标库中是否有同名的表。如果目标库中没有同名的表，则通过该检查项目；如果目标库中有同名的表，则在预检查阶段提示错误，数据同步作业不会被启动。

**说明：** 如果目标库中同名的表不方便删除或重命名，您可以[设置同步对象在目标实例中的名称](/intl.zh-CN/数据同步/同步作业管理/设置同步对象在目标实例中的名称.md)来避免表名冲突。

    -   **忽略报错并继续执行**：跳过目标库中是否有同名表的检查项。

**警告：** 选择为**忽略报错并继续执行**，可能导致数据不一致，给业务带来风险，例如：

        -   表结构一致的情况下，如果在目标库遇到与源库主键的值相同的记录，在初始化阶段会保留目标库中的该条记录；在增量同步阶段则会覆盖目标库的该条记录。
        -   表结构不一致的情况下，可能会导致无法初始化数据、只能同步部分列的数据或同步失败。 |
    |选择同步对象|无|在源库对象框中单击待同步的对象（选择粒度为库或表），然后单击![向右小箭头](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8502659951/p40698.png)将其移动到已选择对象框。

**说明：**

    -   如果选择整个库作为同步对象，该库中所有对象的结构变更操作都会同步至目标库。
    -   默认情况下，同步对象的名称保持不变。如果您需要改变同步对象在目标库中的名称，需要使用对象名映射功能，详情请参见[设置同步对象在目标实例中的名称](/intl.zh-CN/数据同步/同步作业管理/设置同步对象在目标实例中的名称.md)。 |

9.  上述配置完成后，单击页面右下角的**下一步**。
10. 配置同步初始化的高级配置信息。

    ![数据同步高级设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9130649951/p41055.png)

    此步骤会将源实例中已经存在同步对象的结构及数据在目标实例中初始化，作为后续增量同步数据的基线数据。同步初始化类型细分为：**结构初始化**、**全量数据初始化**。默认情况下，需要选择**结构初始化**和**全量数据初始化**。

    **说明：** 如果同步对象中有部分表包含在另外一个同步方向的同步对象中，那么这部分表不会进行同步初始化。

11. 上述配置完成后，单击页面右下角的**预检查并启动**。

    **说明：**

    -   在数据同步任务正式启动之前，会先进行预检查。只有预检查通过后，才能成功启动数据同步任务。
    -   如果预检查失败，单击具体检查项后的![提示](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8502659951/p47468.png)，查看失败详情。根据提示修复后，重新进行预检查。
12. 在预检查对话框中显示**预检查通过**后，关闭预检查对话框，同步作业将正式开始。
13. 等待该同步作业的链路初始化完成，直至状态处于**同步中**。

    您可以在数据同步页面，查看数据同步状态。

14. 定位至第二个同步作业，单击**配置同步链路**，配置流程参见步骤5到步骤12。

    ![配置反向数据同步](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1320649951/p41152.png)

15. 第二个同步作业配置完成后，等待两个同步作业的链路状态均处于**同步中**，即完成双向数据同步的配置流程。

    ![双向数据同步状态](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1320649951/p41154.png)


